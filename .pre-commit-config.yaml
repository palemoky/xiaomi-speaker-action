# Pre-commit hooks configuration
# See https://pre-commit.com for more information

repos:
  # 通用文件检查
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      # 防止提交大文件
      - id: check-added-large-files
        args: ['--maxkb=500']
        exclude: ^dist/

      # 检查合并冲突标记
      - id: check-merge-conflict
        exclude: ^dist/

      # 检查 YAML 语法
      - id: check-yaml
        args: ['--unsafe'] # 允许自定义 YAML 标签

      # 检查 JSON 语法
      - id: check-json
        exclude: ^dist/

      # 检查是否有未解决的合并冲突
      - id: detect-private-key
        exclude: ^dist/

      # 文件末尾添加空行
      - id: end-of-file-fixer
        exclude: ^dist/

      # 移除行尾空格
      - id: trailing-whitespace
        args: ['--markdown-linebreak-ext=md']
        exclude: ^dist/

      # 检查文件名大小写冲突
      - id: check-case-conflict

      # 确保文件以换行符结尾
      - id: mixed-line-ending
        args: ['--fix=lf']
        exclude: ^dist/

  # Prettier 代码格式化
  - repo: local
    hooks:
      - id: prettier
        name: Prettier
        entry: bun run prettier --write --ignore-unknown
        language: system
        types_or: [javascript, jsx, ts, tsx, json, yaml, markdown]
        exclude: ^dist/

  # TypeScript 类型检查（本地）
  - repo: local
    hooks:
      - id: typecheck
        name: TypeScript Type Check
        entry: bun run typecheck
        language: system
        types: [ts]
        pass_filenames: false
        stages: [pre-commit]

      # 运行测试
      - id: test
        name: Run Tests
        entry: bun test
        language: system
        types: [ts]
        pass_filenames: false
        stages: [pre-push]

      # 构建检查
      - id: build
        name: Build Check
        entry: bun run build
        language: system
        types: [ts]
        pass_filenames: false
        stages: [pre-push]

      # 检查 dist 是否已更新
      - id: check-dist
        name: Check dist is up-to-date
        entry: bash -c 'git diff --exit-code dist/ || (echo "❌ dist/ is not up-to-date. Run make build" && exit 1)'
        language: system
        pass_filenames: false
        stages: [pre-push]

      # 检测 TODO/FIXME
      - id: no-todos
        name: Detect TODO/FIXME
        entry: bash -c 'grep -rn "TODO\|FIXME" src/ && echo "❌ Found TODO/FIXME in code. Please resolve before committing." && exit 1 || exit 0'
        language: system
        pass_filenames: false
        stages: [pre-commit]

      # 检测调试代码
      - id: no-debug-code
        name: Detect Debug Code
        entry: bash -c 'grep -rn "console\.log\|debugger" src/ && echo "❌ Found console.log or debugger in code. Please remove before committing." && exit 1 || exit 0'
        language: system
        pass_filenames: false
        stages: [pre-commit]

  # Commit 消息规范检查
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v4.3.0
    hooks:
      - id: conventional-pre-commit
        stages: [commit-msg]
        args:
          - feat
          - fix
          - docs
          - style
          - refactor
          - perf
          - test
          - build
          - ci
          - chore
          - revert

  # 依赖安全扫描
  - repo: local
    hooks:
      - id: audit-dependencies
        name: Audit Dependencies
        entry: bash -c 'bun pm audit || echo "⚠️ Found vulnerabilities in dependencies"'
        language: system
        pass_filenames: false
        stages: [pre-push]

# 全局配置
default_stages: [pre-commit]
fail_fast: false
exclude: ^dist/
